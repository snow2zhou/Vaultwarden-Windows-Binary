name: Vaultwarden Windows Build (Multi-Arch)

on:
  workflow_dispatch:
    inputs:
      tag_choice:
        description: "ç‰ˆæœ¬é€‰æ‹©"
        required: true
        default: "release"
        type: choice
        options:
          - release
          - latest
          - custom
      tag:
        description: "è‡ªå®šä¹‰ commit"
        required: false

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest]
        arch: [x86, x64]
        target-triple: [i686-pc-windows-msvc, x86_64-pc-windows-msvc]
        vcpkg_arch: [x86-windows-static, x64-windows-static]
        include:
          - arch: x86
            target-triple: i686-pc-windows-msvc
            vcpkg_arch: x86-windows-static
            bits: 32
          - arch: x64
            target-triple: x86_64-pc-windows-msvc
            vcpkg_arch: x64-windows-static
            bits: 64
    permissions:
      contents: write

    steps:
      - name: æ£€æŸ¥å·¥å…·ç‰ˆæœ¬
        run: git version && cargo version && vcpkg version

      - name: å®‰è£…Rustç›®æ ‡
        run: |
          rustup target add ${{ matrix.target-triple }}
          rustup target add ${{ matrix.target-triple }} --toolchain stable

      - name: è®¾ç½®Rustå·¥å…·é“¾
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          target: ${{ matrix.target-triple }}
          toolchain: stable

      - name: å®‰è£…äº¤å‰ç¼–è¯‘ç›®æ ‡
        run: |
          rustup target add ${{ matrix.target-triple }} || (
            echo "å¼€å§‹å›é€€å®‰è£…æ–¹å¼..." &&
            rustup toolchain install stable-${{ matrix.target-triple }} &&
            rustup component add rust-std-${{ matrix.target-triple }}
          )
        env:
          VCPKGRS_TRIPLET: ${{ matrix.vcpkg_arch }}
          CARGO_TARGET_I686_PC_WINDOWS_MSVC_LINKER: lld-link

      - name: è·å–ç‰ˆæœ¬å·
        id: get_tag
        run: |
          if ("${{ github.event.inputs.tag_choice }}" -eq "release") {
            $release = Invoke-RestMethod -Uri "https://api.github.com/repos/dani-garcia/vaultwarden/releases/latest"
            echo "tag=$($release.tag_name)" >> $env:GITHUB_OUTPUT
          } elseif ("${{ github.event.inputs.tag_choice }}" -eq "custom") {
            echo "tag=${{ github.event.inputs.tag }}" >> $env:GITHUB_OUTPUT
          } else {
            echo "tag=" >> $env:GITHUB_OUTPUT
          }

      - name: å…‹éš†ä»“åº“
        uses: actions/checkout@v4
        with:
          repository: dani-garcia/vaultwarden
          ref: ${{ steps.get_tag.outputs.tag || 'main' }}
          path: vaultwarden

      - name: åˆ‡æ¢ç‰ˆæœ¬
        if: ${{ steps.get_tag.outputs.tag != '' }}
        run: git checkout ${{ steps.get_tag.outputs.tag }}
        working-directory: vaultwarden

      - name: ä¸‹è½½ web-vault
        run: |
          $Release = Invoke-RestMethod -Uri "https://api.github.com/repos/dani-garcia/bw_web_builds/releases/latest"
          $Asset = $Release.assets | Where-Object {
              ($_.name -like "web-vault-*.tar.gz") -or 
              ($_.name -match "^web-vault-v\d+\.\d+\.\d+\.tar\.gz$") -or
              ($_.name -like "*web*.tar.gz") -or
              ($_.name -like "*.tar.gz")
          }

          if (-not $Asset) {
              Write-Error "âŒ æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„web-vaultèµ„äº§ï¼Œè¯·æ£€æŸ¥ä»¥ä¸‹å¯èƒ½åŸå› ï¼š"
              Write-Error "1. å®˜æ–¹Releaseå‘½åè§„èŒƒå·²å˜æ›´ï¼ˆå½“å‰æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…æ ¼å¼ï¼šweb-vault-vX.Y.Z.tar.gz)"
              Write-Error "2. GitHub APIè¿”å›é”™è¯¯ï¼š$($Release.message)"
              exit 1
          }

          if (-not $Asset.browser_download_url) {
              Write-Error "ğŸ” èµ„äº§ä¸‹è½½é“¾æ¥ä¸å­˜åœ¨ï¼Œå¯èƒ½åŸå› ï¼š"
              Write-Error "- GitHub APIè¿”å›æ ¼å¼å˜åŒ–ï¼ˆå½“å‰è·å–è·¯å¾„ï¼š.assets[].browser_download_url)"
              Write-Error "- èµ„äº§ID $($Asset.id) æœªåŒ…å«æ­£ç¡®ä¸‹è½½é“¾æ¥"
              exit 1
          }              

          [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12

          try {
            $DownloadUrl = $Asset.browser_download_url
            $FileName = $Asset.name
            $OutPath = "web-vault"
            Write-Host "Downloading $FileName..."
            Invoke-WebRequest -Uri $DownloadUrl -OutFile $FileName
            Write-Host "Extracting..."
            if (-not (Test-Path -Path $OutPath)) {
              New-Item -ItemType Directory -Path $OutPath
            }
            tar -xf $FileName -C $OutPath --strip-components=1
          }catch{
            Write-Error "ğŸ’¥ ä¸‹è½½å¤±è´¥ï¼ŒæŠ€æœ¯ç»†èŠ‚ï¼š$($_.Exception.Message)"
            exit 1
          }

      - name: é…ç½®vcpkg
        run: |
          vcpkg integrate install
          vcpkg install openssl:${{ matrix.vcpkg_arch }}
          vcpkg install libmariadb:${{ matrix.vcpkg_arch }}
          vcpkg install libpq:${{ matrix.vcpkg_arch }}
        env:
          VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite"
          VCPKG_DEFAULT_TRIPLET: ${{ matrix.vcpkg_arch }}

      - name: ç¼“å­˜vcpkg
        uses: actions/cache@v4
        with:
          path: |
            ~/vcpkg/installed
            ~/vcpkg/buildtrees
          key: ${{ runner.os }}-vcpkg-${{ matrix.arch }}-${{ hashFiles('**/vcpkg.json') }}

      - name: æ·»åŠ ç¼–è¯‘ç›®æ ‡
        run: rustup target add ${{ matrix.target-triple }}

      - name: ç¼–è¯‘é¡¹ç›®
        run: 
          cargo build `
            --features "sqlite,mysql,postgresql" `
            --release `
            --target ${{ matrix.target-triple }} `
            -Z build-std=std,panic=abort
        working-directory: vaultwarden
        env:
          RUSTFLAGS: "-Ctarget-feature=+crt-static -Clinker=lld-link"
          CARGO_TARGET_DIR: "target/${{ matrix.target-triple }}"
          POSTGRESQL_LIB_DIR: "${{ github.workspace }}/vcpkg/installed/${{ matrix.vcpkg_arch }}/lib"
          MYSQLCLIENT_LIB_DIR: "${{ github.workspace }}/vcpkg/installed/${{ matrix.vcpkg_arch }}/lib"
          MYSQLCLIENT_INCLUDE_DIR: "${{ github.workspace }}/vcpkg/installed/${{ matrix.vcpkg_arch }}/include/mysql/mariadb"

      - name: ç§»åŠ¨æ–‡ä»¶
        run: |
          $targetDir = "vaultwarden/target/${{ matrix.target-triple }}/release"
          Move-Item -Path "$targetDir/vaultwarden.exe" -Destination "./vaultwarden-${{ matrix.arch }}.exe"

      - name: ç‰ˆæœ¬æ£€æµ‹
        id: version
        run: |
          $version = .\vaultwarden-${{ matrix.arch }}.exe -v | Select-String -Pattern "Vaultwarden (\d+\.\d+\.\d+)"
          echo "version=$($version.Matches.Groups.Value)" >> $env:GITHUB_OUTPUT

      - name: æ‰“åŒ…åˆ†å‘
        run: |
          $packageName = "vaultwarden-${{ matrix.arch }}-${{ steps.version.outputs.version }}.zip"
          Compress-Archive -Path "vaultwarden-${{ matrix.arch }}.exe", "web-vault", ".env.template" -DestinationPath $packageName

      - name: åˆ›å»ºRelease
        if: ${{ github.event.inputs.tag_choice != 'latest' }}
        uses: softprops/action-gh-release@v2
        with:
          files: |
            vaultwarden-*-${{ steps.version.outputs.version }}.zip
          tag_name: v${{ steps.version.outputs.version }}-${{ matrix.arch }}
          name: "Vaultwarden ${{ steps.version.outputs.version }} (${{ matrix.arch }})"
