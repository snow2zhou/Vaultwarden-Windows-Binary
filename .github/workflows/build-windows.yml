name: Vaultwarden Windows Build (Full DB Support)

on:
  workflow_dispatch:
    inputs:
      tag_choice:
        description: "版本选择"
        required: true
        default: "release"
        type: choice
        options:
          - release
          - latest
          - custom
      tag:
        description: "自定义 commit"
        required: false

jobs:
  build:
    runs-on: windows-latest
    env:
      VCPKG_DEFAULT_TRIPLET: x64-windows-static
      VCPKG_ROOT: ${{ github.workspace }}/vcpkg

    steps:
      - name: 检查工具版本
        run: git version && cargo version && vcpkg version

      - name: vaultwarden 版本选择
        id: get_tag
        run: |
          if ("${{ github.event.inputs.tag_choice }}" -eq "release") {
            $release = Invoke-RestMethod -Uri "https://api.github.com/repos/dani-garcia/vaultwarden/releases/latest"
            echo "Using release tag: $($release.tag_name)"
            echo "tag=$($release.tag_name)" >> $env:GITHUB_OUTPUT
          } elseif ("${{ github.event.inputs.tag_choice }}" -eq "latest") {
            echo "Using latest commit"
            echo "tag=" >> $env:GITHUB_OUTPUT
          } elseif ("${{ github.event.inputs.tag_choice }}" -eq "custom") {
            echo "Using custom tag: ${{ github.event.inputs.tag }}"
            echo "tag=${{ github.event.inputs.tag }}" >> $env:GITHUB_OUTPUT
          }

      - name: 克隆 vaultwarden 仓库
        run: git clone https://github.com/dani-garcia/vaultwarden

      - name: 切换版本
        if: ${{ steps.get_tag.outputs.tag != '' }}
        run: git switch --detach "${{ steps.get_tag.outputs.tag }}"
        working-directory: vaultwarden

      - name: 下载 web-vault
        run: |
          $Release = Invoke-RestMethod -Uri "https://api.github.com/repos/dani-garcia/bw_web_builds/releases/latest"
          $Asset = $Release.assets | Where-Object { $_.name -like "*.tar.gz" }
          Invoke-WebRequest -Uri $Asset.browser_download_url -OutFile web-vault.tar.gz
          tar -xf web-vault.tar.gz

      - name: 初始化vcpkg
        run: |
          git clone https://github.com/Microsoft/vcpkg
          .\vcpkg\bootstrap-vcpkg.bat
          .\vcpkg\vcpkg integrate install

      - name: 安装数据库依赖
        run: |
          .\vcpkg\vcpkg install openssl:x64-windows-static
          .\vcpkg\vcpkg install libpq:x64-windows-static    # PostgreSQL
          .\vcpkg\vcpkg install libmysql:x64-windows-static # MySQL
          .\vcpkg\vcpkg install sqlite3:x64-windows-static  # SQLite
        env:
          VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite"

      - name: 编译Vaultwarden
        run: cargo build --features "sqlite,mysql,postgresql" --release
        working-directory: vaultwarden
        env:
          RUSTFLAGS: "-Ctarget-feature=+crt-static"
          OPENSSL_NO_VENDOR: 1
          POSTGRESQL_LIB_DIR: "${{ github.workspace }}/vcpkg/installed/x64-windows-static/lib"
          MYSQL_LIB_DIR: "${{ github.workspace }}/vcpkg/installed/x64-windows-static/lib"
          SQLITE3_LIB_DIR: "${{ github.workspace }}/vcpkg/installed/x64-windows-static/lib"
          LIB: "${{ github.workspace }}/vcpkg/installed/x64-windows-static/lib"

      - name: 打包输出
        uses: actions/upload-artifact@v4
        with:
          name: Vaultwarden_FullDB_${{ steps.get_version.outputs.vaultwarden_version }}
          path: |
            vaultwarden/target/release/vaultwarden.exe
            web-vault/
