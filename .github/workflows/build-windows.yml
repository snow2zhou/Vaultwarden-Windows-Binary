name: Vaultwarden Windows Build (Full DB Support) - Multi-Arch

on:
  workflow_dispatch:
    inputs:
      tag_choice:
        description: "版本选择"
        required: true
        default: "release"
        type: choice
        options:
          - release
          - latest
          - custom
      tag:
        description: "自定义 commit"
        required: false

jobs:
  build:
    strategy:
      matrix:
        arch: [x64, x86]
        include:
          - arch: x64
            target: x86_64-pc-windows-msvc
            vcpkg_triplet: x64-windows-static
            rust_target: x86_64-pc-windows-msvc
          - arch: x86
            target: i686-pc-windows-msvc
            vcpkg_triplet: x86-windows-static
            rust_target: i686-pc-windows-msvc
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: 检查工具版本
        run: git version && cargo version && vcpkg version

      - name: vaultwarden 版本选择
        id: get_tag
        run: |
          if ("${{ github.event.inputs.tag_choice }}" -eq "release") {
            $release = Invoke-RestMethod -Uri "https://api.github.com/repos/dani-garcia/vaultwarden/releases/latest"
            echo "Using release tag: $($release.tag_name)"
            echo "tag=$($release.tag_name)" >> $env:GITHUB_OUTPUT
          } elseif ("${{ github.event.inputs.tag_choice }}" -eq "latest") {
            echo "Using latest commit"
            echo "tag=" >> $env:GITHUB_OUTPUT
          } elseif ("${{ github.event.inputs.tag_choice }}" -eq "custom") {
            echo "Using custom tag: ${{ github.event.inputs.tag }}"
            echo "tag=${{ github.event.inputs.tag }}" >> $env:GITHUB_OUTPUT
          }

      - name: 克隆 vaultwarden 仓库
        run: git clone https://github.com/dani-garcia/vaultwarden

      - name: 切换版本
        if: ${{ steps.get_tag.outputs.tag != '' }}
        run: git switch --detach "${{ steps.get_tag.outputs.tag }}"
        working-directory: vaultwarden

      - name: 下载 web-vault
        run: |
          $Release = Invoke-RestMethod -Uri "https://api.github.com/repos/dani-garcia/bw_web_builds/releases/latest"
          $Asset = $Release.assets | Where-Object { $_.name -like "*.tar.gz" }

          if (-not $Asset) {
            Write-Error "No .tar.gz asset found."
            exit 1
          }

          $DownloadUrl = $Asset.browser_download_url
          $FileName = $Asset.name
          $OutPath = "web-vault"

          Write-Host "Downloading $FileName..."
          Invoke-WebRequest -Uri $DownloadUrl -OutFile $FileName

          Write-Host "Extracting..."
          if (-not (Test-Path -Path $OutPath)) {
              New-Item -ItemType Directory -Path $OutPath
          }
          tar -xf $FileName -C $OutPath --strip-components=1

      - name: 配置 vcpkg 缓存
        uses: actions/github-script@v7
        with:
          script: |
            core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
            core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

      - name: 安装 Rust 目标
        run: rustup target add ${{ matrix.rust_target }}

      - name: 使用vcpkg安装依赖
        run: |
          vcpkg integrate install
          vcpkg install openssl:${{ matrix.vcpkg_triplet }}
          vcpkg install libmariadb:${{ matrix.vcpkg_triplet }}
          vcpkg install libpq:${{ matrix.vcpkg_triplet }}
        env:
          VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite"
          
      - name: 缓存vcpkg依赖
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/vcpkg/installed
          key: vcpkg-${{ matrix.arch }}-${{ hashFiles('**/vcpkg.json') }}

      - name: 编译 vaultwarden
        run: cargo build --features "sqlite,mysql,postgresql" --release --target ${{ matrix.rust_target }}
        working-directory: vaultwarden
        env:
          RUSTFLAGS: "-Ctarget-feature=+crt-static"
          POSTGRESQL_LIB_DIR: "${{ github.workspace }}/vcpkg/installed/${{ matrix.vcpkg_triplet }}/lib"
          MYSQLCLIENT_VERSION: "3.1.0"
          MYSQLCLIENT_LIB_DIR: "${{ github.workspace }}/vcpkg/installed/${{ matrix.vcpkg_triplet }}/lib"
          MYSQLCLIENT_INCLUDE_DIR: "${{ github.workspace }}/vcpkg/installed/${{ matrix.vcpkg_triplet }}/include/mysql/mariadb"

      - name: 移动文件
        run: |
          mkdir -p artifacts/${{ matrix.arch }}
          move .\vaultwarden\target\${{ matrix.rust_target }}\release\vaultwarden.exe .\artifacts\${{ matrix.arch }}\vaultwarden.exe

      - name: 下载 .env.template
        run: |
          $tag = "${{ steps.get_tag.outputs.tag }}"
          if (-not $tag) { $tag = "main" }
          $url = "https://raw.githubusercontent.com/dani-garcia/vaultwarden/$tag/.env.template"
          Invoke-WebRequest -Uri $url -OutFile .\artifacts\${{ matrix.arch }}\.env.template

      - name: 版本信息
        id: get_version
        run: |
          $version_output = .\artifacts\${{ matrix.arch }}\vaultwarden.exe -v
          $vaultwarden_version = ($version_output | Select-String -Pattern "(?i)Vaultwarden (\S+)").Matches.Groups[1].Value
          $web_vault_version = ($version_output | Select-String -Pattern "(?i)Web-Vault (\S+)").Matches.Groups[1].Value

          echo "vaultwarden_version=$vaultwarden_version" >> $env:GITHUB_OUTPUT
          echo "web_vault_version=$web_vault_version" >> $env:GITHUB_OUTPUT

      - name: 打包文件
        run: |
          mkdir -p temp_package_${{ matrix.arch }}
          copy .\artifacts\${{ matrix.arch }}\vaultwarden.exe temp_package_${{ matrix.arch }}
          if (-not (Test-Path -Path .\web-vault)) {
              Write-Error "Web-vault directory not found. Ensure the '下载 web-vault' step correctly extracts content into a 'web-vault' directory."
              exit 1
          }
          xcopy /E /I web-vault temp_package_${{ matrix.arch }}\web-vault
          copy .\artifacts\${{ matrix.arch }}\.env.template temp_package_${{ matrix.arch }}
          tar -czvf vaultwarden-${{ matrix.arch }}-full-${{ steps.get_version.outputs.vaultwarden_version }}-web-${{ steps.get_version.outputs.web_vault_version }}.tar.gz -C temp_package_${{ matrix.arch }} .

      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: vaultwarden-${{ matrix.arch }}
          path: |
            vaultwarden-${{ matrix.arch }}-full-${{ steps.get_version.outputs.vaultwarden_version }}-web-${{ steps.get_version.outputs.web_vault_version }}.tar.gz
          retention-days: 7

  release:
    needs: build
    if: ${{ github.event.inputs.tag_choice == 'release' || github.event.inputs.tag_choice == 'custom' }}
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      - name: 下载所有构建产物
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
          pattern: vaultwarden-*
          merge-multiple: true

      - name: 获取版本信息
        id: get_version
        run: |
          # 从任意一个架构的可执行文件中获取版本信息
          $arch = "x64"  # 使用 x64 版本获取版本信息
          $exe_path = ".\artifacts\vaultwarden-$arch\vaultwarden.exe"
          if (Test-Path $exe_path) {
            $version_output = & $exe_path -v
            $vaultwarden_version = ($version_output | Select-String -Pattern "(?i)Vaultwarden (\S+)").Matches.Groups[1].Value
            $web_vault_version = ($version_output | Select-String -Pattern "(?i)Web-Vault (\S+)").Matches.Groups[1].Value
            
            echo "vaultwarden_version=$vaultwarden_version" >> $env:GITHUB_OUTPUT
            echo "web_vault_version=$web_vault_version" >> $env:GITHUB_OUTPUT
          } else {
            echo "vaultwarden_version=unknown" >> $env:GITHUB_OUTPUT
            echo "web_vault_version=unknown" >> $env:GITHUB_OUTPUT
          }

      - name: 创建 GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: |
            ./artifacts/vaultwarden-x64/vaultwarden-x64-full-*.tar.gz
            ./artifacts/vaultwarden-x86/vaultwarden-x86-full-*.tar.gz
          tag_name: v${{ steps.get_version.outputs.vaultwarden_version }}-web-${{ steps.get_version.outputs.web_vault_version }}
          release_name: "v${{ steps.get_version.outputs.vaultwarden_version }}-web-${{ steps.get_version.outputs.web_vault_version }}"
          body: |
            ### 构建信息
            - Vaultwarden 版本: `${{ steps.get_version.outputs.vaultwarden_version }}`
            - Web-Vault 版本: `${{ steps.get_version.outputs.web_vault_version }}`
            
            ### 包含的架构
            - **x64 (64位)**: 适用于 64 位 Windows 系统
            - **x86 (32位)**: 适用于 32 位 Windows 系统
            
            ### 功能特性
            - 支持 SQLite、MySQL、PostgreSQL 数据库
            - 静态链接运行时库
            - 包含最新的 Web-Vault 界面
            
            ### 使用说明
            1. 根据您的系统架构下载对应的压缩包
            2. 解压到任意目录
            3. 根据需要修改 `.env.template` 为 `.env` 并配置
            4. 运行 `vaultwarden.exe`
