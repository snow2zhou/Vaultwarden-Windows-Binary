name: Vaultwarden Windows Build (Full DB Support)

on:
  workflow_dispatch:
    inputs:
      tag_choice:
        description: "版本选择"
        required: true
        default: "release"
        type: choice
        options:
          - release
          - latest
          - custom
      tag:
        description: "自定义 commit"
        required: false
      target_arch: # 新增：选择目标架构
        description: "目标架构选择"
        required: true
        default: "x64"
        type: choice
        options:
          - x86
          - x64

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write

    strategy: # 新增：使用策略来并行构建 x86 和 x64 版本
      matrix:
        arch: [x86, x64] # 定义需要构建的架构
        exclude: # 排除不希望的组合（例如，如果 workflow_dispatch 中已经选定，这里可以更灵活）
          - arch: x86 # 暂时不排除，允许用户在 workflow_dispatch 选择
          - arch: x64

    steps:
      - name: 检查工具版本
        run: git version && cargo version && vcpkg version

      - name: vaultwarden 版本选择
        id: get_tag
        run: |
          if ("${{ github.event.inputs.tag_choice }}" -eq "release") {
            $release = Invoke-RestMethod -Uri "https://api.github.com/repos/dani-garcia/vaultwarden/releases/latest"
            echo "Using release tag: $($release.tag_name)"
            echo "tag=$($release.tag_name)" >> $env:GITHUB_OUTPUT
          } elseif ("${{ github.event.inputs.tag_choice }}" -eq "latest") {
            echo "Using latest commit"
            echo "tag=" >> $env:GITHUB_OUTPUT
          } elseif ("${{ github.event.inputs.tag_choice }}" -eq "custom") {
            echo "Using custom tag: ${{ github.event.inputs.tag }}"
            echo "tag=${{ github.event.inputs.tag }}" >> $env:GITHUB_OUTPUT
          }

      - name: 克隆 vaultwarden 仓库
        run: git clone https://github.com/dani-garcia/vaultwarden

      - name: 切换版本
        if: ${{ steps.get_tag.outputs.tag != '' }}
        run: git switch --detach "${{ steps.get_tag.outputs.tag }}"
        working-directory: vaultwarden

      - name: 下载 web-vault
        run: |
          $Release = Invoke-RestMethod -Uri "https://api.github.com/repos/dani-garcia/bw_web_builds/releases/latest"
          $Asset = $Release.assets | Where-Object { $_.name -like "*.tar.gz" }

          if (-not $Asset) {
            Write-Error "No .tar.gz asset found."
            exit 1
          }

          $DownloadUrl = $Asset.browser_download_url
          $FileName = $Asset.name
          $OutPath = "web-vault"

          Write-Host "Downloading $FileName..."
          Invoke-WebRequest -Uri $DownloadUrl -OutFile $FileName

          Write-Host "Extracting..."
          if (-not (Test-Path -Path $OutPath)) {
              New-Item -ItemType Directory -Path $OutPath
          }
          tar -xf $FileName -C $OutPath --strip-components=1

      # --- vcpkg 配置修改 ---
      - name: 设置 vcpkg 目标架构
        id: set_vcpkg_arch
        run: |
          # 根据 job matrix 的 arch 设置 vcpkg triplet
          if ("${{ matrix.arch }}" -eq "x86") {
            echo "vcpkg_triplet=x86-windows-static" >> $env:GITHUB_OUTPUT
            echo "target_arch=i686-pc-windows-msvc" >> $env:GITHUB_OUTPUT # Rust target for x86
            echo "lib_suffix=-x86" >> $env:GITHUB_OUTPUT # 某些库可能需要区分
          } elseif ("${{ matrix.arch }}" -eq "x64") {
            echo "vcpkg_triplet=x64-windows-static" >> $env:GITHUB_OUTPUT
            echo "target_arch=x86_64-pc-windows-msvc" >> $env:GITHUB_OUTPUT # Rust target for x64
            echo "lib_suffix=" >> $env:GITHUB_OUTPUT # 64位通常不需要后缀
          }

      - name: 配置 vcpkg 缓存
        uses: actions/github-script@v7
        with:
          script: |
            core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
            core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

      - name: 使用vcpkg安装依赖
        run: |
          vcpkg integrate install
          # 使用上面设置的 vcpkg triplet
          vcpkg install openssl:${{ steps.set_vcpkg_arch.outputs.vcpkg_triplet }}
          vcpkg install libmariadb:${{ steps.set_vcpkg_arch.outputs.vcpkg_triplet }}
          vcpkg install libpq:${{ steps.set_vcpkg_arch.outputs.vcpkg_triplet }}
        env:
          VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite"

      - name: 缓存vcpkg依赖
        uses: actions/cache@v4
        with:
          # 缓存路径需要包含目标架构，以区分 x86 和 x64
          path: ${{ github.workspace }}/vcpkg/installed/${{ steps.set_vcpkg_arch.outputs.vcpkg_triplet }}
          # 缓存key需要包含目标架构
          key: vcpkg-${{ matrix.arch }}-${{ hashFiles('**/vcpkg.json') }}

      # --- Rust 编译修改 ---
      - name: 编译 vaultwarden
        run: |
          cargo build --features "sqlite,mysql,postgresql" --release --target ${{ steps.set_vcpkg_arch.outputs.target_arch }}
        working-directory: vaultwarden
        env:
          # RUSTFLAGS 保持不变，因为 +crt-static 是通用的
          RUSTFLAGS: "-Ctarget-feature=+crt-static"
          # 环境变量需要根据目标架构动态设置
          POSTGRESQL_LIB_DIR: "${{ github.workspace }}/vcpkg/installed/${{ steps.set_vcpkg_arch.outputs.vcpkg_triplet }}/lib"
          MYSQLCLIENT_VERSION: "3.1.0"
          # 确保MYSQLCLIENT_LIB_DIR 指向正确的架构下的 lib 目录
          MYSQLCLIENT_LIB_DIR: "${{ github.workspace }}/vcpkg/installed/${{ steps.set_vcpkg_arch.outputs.vcpkg_triplet }}/lib"
          # 确保 MYSQLCLIENT_INCLUDE_DIR 指向正确的架构下的 include 目录
          MYSQLCLIENT_INCLUDE_DIR: "${{ github.workspace }}/vcpkg/installed/${{ steps.set_vcpkg_arch.outputs.vcpkg_triplet }}/include/mysql/mariadb"

      - name: 移动文件
        run: |
          # 输出文件名称现在需要包含架构信息
          move .\vaultwarden\target\${{ steps.set_vcpkg_arch.outputs.target_arch }}\release\vaultwarden.exe .\vaultwarden-${{ matrix.arch }}.exe

      - name: 下载 .env.template
        run: |
          $tag = "${{ steps.get_tag.outputs.tag }}"
          if (-not $tag) { $tag = "main" }
          $url = "https://raw.githubusercontent.com/dani-garcia/vaultwarden/$tag/.env.template"
          Invoke-WebRequest -Uri $url -OutFile .env.template

      - name: 版本信息
        id: get_version
        run: |
          # 使用带架构后缀的可执行文件
          $version_output = .\vaultwarden-${{ matrix.arch }}.exe -v
          $vaultwarden_version = ($version_output | Select-String -Pattern "(?i)Vaultwarden (\S+)").Matches.Groups[1].Value
          $web_vault_version = ($version_output | Select-String -Pattern "(?i)Web-Vault (\S+)").Matches.Groups[1].Value

          echo "vaultwarden_version=$vaultwarden_version" >> $env:GITHUB_OUTPUT
          echo "web_vault_version=$web_vault_version" >> $env:GITHUB_OUTPUT

      - name: 打包所有文件
        run: |
          mkdir temp_package_${{ matrix.arch }}
          copy .\vaultwarden-${{ matrix.arch }}.exe temp_package_${{ matrix.arch }}
          if (-not (Test-Path -Path .\web-vault)) {
              Write-Error "Web-vault directory not found. Ensure the '下载 web-vault' step correctly extracts content into a 'web-vault' directory."
              exit 1
          }
          # 使用 xcopy 复制 web-vault 内容到目标包目录
          xcopy /E /I web-vault temp_package_${{ matrix.arch }}\web-vault
          copy .env.template temp_package_${{ matrix.arch }}
          # 输出文件名称包含架构信息
          tar -czvf vaultwarden-full-${{ steps.get_version.outputs.vaultwarden_version }}-web-${{ steps.get_version.outputs.web_vault_version }}-${{ matrix.arch }}.tar.gz -C temp_package_${{ matrix.arch }} .

      - name: 创建 GitHub Release
        if: ${{ github.event.inputs.tag_choice == 'release' || github.event.inputs.tag_choice == 'custom' }}
        id: create_release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          # 文件名现在包含架构信息
          files: |
            ./vaultwarden-full-${{ steps.get_version.outputs.vaultwarden_version }}-web-${{ steps.get_version.outputs.web_vault_version }}-${{ matrix.arch }}.tar.gz
          # tag_name 现在包含架构信息，方便区分
          tag_name: v${{ steps.get_version.outputs.vaultwarden_version }}-web-${{ steps.get_version.outputs.web_vault_version }}-${{ matrix.arch }}
          # release_name 也包含架构信息
          release_name: "v${{ steps.get_version.outputs.vaultwarden_version }}-web-${{ steps.get_version.outputs.web_vault_version }} (${{ matrix.arch }})"
          body: |
            ### 构建信息
            - Vaultwarden 版本: `${{ steps.get_version.outputs.vaultwarden_version }}`
            - Web-Vault 版本: `${{ steps.get_version.outputs.web_vault_version }}`
            - 目标架构: `${{ matrix.arch }}`
